// Ported from https://github.com/mafintosh/end-of-stream with
// permission from the author, Mathias Buus (@mafintosh).

'use strict';

var ERR_STREAM_PREMATURE_CLOSE = require('../../../errors').codes.ERR_STREAM_PREMATURE_CLOSE;
/**
 * Creates a function that can only be called once. Subsequent calls to this function will not execute the callback.
 *
 * @param {Function} callback - The function to be executed once.
 * @returns {Function} A new function that, when called, will call the provided callback only if it hasn't been called before.
 */
function once(callback) {
  var called = false;
  return function () {
    if (called) return;
    called = true;
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }
    callback.apply(this, args);
  };
}
/**
 * A no-operation function that does nothing.
 *
 * @function
 * @name noop
 */
function noop() {}
/**
 * Determines if an object represents a request by checking for specific properties.
 *
 * @param {any} stream - The object to check.
 * @returns {boolean} Returns true if the object appears to be a request, false otherwise.
 */
function isRequest(stream) {
  return stream.setHeader && typeof stream.abort === 'function';
}
/**
 * Wraps a stream to provide an end-of-stream event that fires when both the readable and writable sides of the stream have ended.
 *
 * @param {stream.Stream} stream - The input stream.
 * @param {Object} [opts] - Optional configuration options.
 * @param {boolean} [opts.readable=true] - Whether to listen for 'end' event on the readable side of the stream.
 * @param {boolean} [opts.writable=true] - Whether to listen for 'finish' event on the writable side of the stream.
 * @param {function} [callback] - Callback function to be called when the end-of-stream event occurs. Receives an error as its argument if any occurred.
 * @returns {function} A cleanup function that removes all added listeners from the stream.
 *
 * @example
 * const eos = require('end-of-stream');
 *
 * eos(fs.createReadStream('/path/to/file'), (err) => {
 *   if (err) return console.error(err);
 *   console.log('File has finished reading.');
 * });
 */
function eos(stream, opts, callback) {
  if (typeof opts === 'function') return eos(stream, null, opts);
  if (!opts) opts = {};
  callback = once(callback || noop);
  var readable = opts.readable || opts.readable !== false && stream.readable;
  var writable = opts.writable || opts.writable !== false && stream.writable;
  var onlegacyfinish = function onlegacyfinish() {
    if (!stream.writable) onfinish();
  };
  var writableEnded = stream._writableState && stream._writableState.finished;
  var onfinish = function onfinish() {
    writable = false;
    writableEnded = true;
    if (!readable) callback.call(stream);
  };
  var readableEnded = stream._readableState && stream._readableState.endEmitted;
  var onend = function onend() {
    readable = false;
    readableEnded = true;
    if (!writable) callback.call(stream);
  };
  var onerror = function onerror(err) {
    callback.call(stream, err);
  };
  var onclose = function onclose() {
    var err;
    if (readable && !readableEnded) {
      if (!stream._readableState || !stream._readableState.ended) err = new ERR_STREAM_PREMATURE_CLOSE();
      return callback.call(stream, err);
    }
    if (writable && !writableEnded) {
      if (!stream._writableState || !stream._writableState.ended) err = new ERR_STREAM_PREMATURE_CLOSE();
      return callback.call(stream, err);
    }
  };
  var onrequest = function onrequest() {
    stream.req.on('finish', onfinish);
  };
  if (isRequest(stream)) {
    stream.on('complete', onfinish);
    stream.on('abort', onclose);
    if (stream.req) onrequest();else stream.on('request', onrequest);
  } else if (writable && !stream._writableState) {
    // legacy streams
    stream.on('end', onlegacyfinish);
    stream.on('close', onlegacyfinish);
  }
  stream.on('end', onend);
  stream.on('finish', onfinish);
  if (opts.error !== false) stream.on('error', onerror);
  stream.on('close', onclose);
  return function () {
    stream.removeListener('complete', onfinish);
    stream.removeListener('abort', onclose);
    stream.removeListener('request', onrequest);
    if (stream.req) stream.req.removeListener('finish', onfinish);
    stream.removeListener('end', onlegacyfinish);
    stream.removeListener('close', onlegacyfinish);
    stream.removeListener('finish', onfinish);
    stream.removeListener('end', onend);
    stream.removeListener('error', onerror);
    stream.removeListener('close', onclose);
  };
}
module.exports = eos;